<template>
  <div class="py-3">
    <b-container @submit.prevent="handleSave" tag="form">
      <b-row>
        <b-col v-if="chart" md="12">
          <b-card
            :title="$t('chart.edit.title')"
          >
            <export :list="[chart]" type="chart" class="float-right" slot="header"/>
            <b-row>
              <b-col md="6">
                <fieldset v-if="modules">
                  <b-form-input v-model="chart.name" :placeholder="$t('chart.newPlaceholder')" class="mb-1"></b-form-input>
                  <b-form-input v-model="chart.handle" :placeholder="$t('general.placeholder.handle')" :state="handleState" class="mb-1"></b-form-input>
                </fieldset>

                <!-- Some charts support multiple reports -->
                <fieldset
                  v-if="supportsMultipleReports"
                  class="form-group mt-2"
                >
                  <b-form-group>
                    <h4>
                      {{ $t('block.chart.configure.reportsLabel') }}
                    </h4>
                    <div class="pl-3">
                      <draggable
                        v-model="reports"
                        :options="{ handle:'.handle' }"
                        element="tbody"
                      >

                        <report-item
                          v-for="(r, i) in reports"
                          :key="i"
                          :report="r"
                          :fixed="reports.length === 1"
                          @edit="onEditReport(i)"
                          @remove="onRemoveReport(i)"
                        >
                          <template #report-label>
                            {{ $t('block.chart.configure.reportLabel', { l: i + 1 }) }}
                          </template>
                        </report-item>
                      </draggable>
                    </div>
                  </b-form-group>

                  <b-btn
                    class="float-left mt-2"
                    variant="link"
                    @click="onAddReport"
                  >
                    + {{ $t('general.label.add') }}
                  </b-btn>
                </fieldset>

                <!-- Generic report editing component -->
                <component
                  :is="reportEditor"
                  v-if="editReport"
                  :report.sync="editReport"
                  :modules="modules"
                  :dimension-field-kind="['Select']"
                  :supported-metrics="1"
                />
              </b-col>

              <b-col md="6">
                <b-button v-if="!error"
                          @click.prevent="update"
                          :disabled="processing"
                          class="float-right"
                          variant="outline-primary">{{ $t('chart.edit.loadData') }}
                </b-button>
                <b-alert
                  :show="error"
                  variant="warning"
                >
                  {{ error }}
                </b-alert>

                <div class="chart-preview w-100 h-100">
                  <chart-component
                    v-if="chart"
                    :chart="chart"
                    :reporter="reporter"
                    ref="chart"
                    width="200"
                    height="200"
                    @error="error=$event"
                    @updated="onUpdated"
                  />
                </div>
                <!-- not supporting multiple reports for now
<b-button @click.prevent="reports.push(defaultReport)"
        v-if="false"
        class="float-right">+ Add report</b-button>
-->
              </b-col>
            </b-row>
          </b-card>
        </b-col>
      </b-row>
    </b-container>
    <portal to="admin-toolbar">
      <editor-toolbar
        v-if="chart"
        :back-link="{name: 'admin.charts'}"
        :hideDelete="!chart.canDeleteChart"
        :hideSave="!chart.canUpdateChart"
        @delete="handleDelete"
        @save="handleSave()"
        @saveAndClose="handleSave({ closeOnSuccess: true })">
      </editor-toolbar>
    </portal>
  </div>
</template>
<script>
import { mapGetters, mapActions } from 'vuex'
import Report from 'corteza-webapp-compose/src/components/Admin/Chart/Editor/Report'
import EditorToolbar from 'corteza-webapp-compose/src/components/Admin/EditorToolbar'
import { compose } from '@cortezaproject/corteza-js'
import Export from 'corteza-webapp-compose/src/components/Admin/Export'
import ChartComponent from 'corteza-webapp-compose/src/components/Chart'
import { handleState } from 'corteza-webapp-compose/src/lib/handle'
import draggable from 'vuedraggable'
import ReportItem from './components/ReportItem'
import Reports from './components/Report'
import { chartConstructor } from 'corteza-webapp-compose/src/lib/charts'

const defaultReport = {
  moduleID: undefined,
  metrics: [{ field: 'count' }],
  dimensions: [{ field: 'created_at', modifier: 'MONTH' }],
}

export default {
  components: {
    Report,
    EditorToolbar,
    Export,
    ChartComponent,
    draggable,
    ReportItem,
  },

  props: {
    namespace: {
      type: compose.Namespace,
      required: true,
    },

    chartID: {
      type: String,
      required: true,
    },
  },

  data () {
    return {
      chart: new compose.Chart(),
      error: null,
      processing: false,

      editReportIndex: undefined,
    }
  },

  computed: {
    ...mapGetters({
      modules: 'module/set',
    }),

    defaultReport () {
      return Object.assign({}, defaultReport)
    },

    handleState () {
      return handleState(this.chart.handle)
    },

    supportsMultipleReports () {
      if (!this.chart) {
        return false
      }

      if (this.chart instanceof compose.FunnelChart) {
        return true
      }
      return false
    },

    reportEditor () {
      if (!this.chart) {
        return undefined
      }

      if (this.chart instanceof compose.FunnelChart) {
        return Reports.FunnelChart
      }
      if (this.chart instanceof compose.GaugeChart) {
        return Reports.GagueChart
      }
      return Reports.GenericChart
    },

    reports: {
      get () {
        return this.chart.config.reports
      },
      set (r) {
        this.chart.config.reports = r
      },
    },

    editReport: {
      get () {
        if (this.editReportIndex !== undefined) {
          return this.reports[this.editReportIndex]
        }
        return undefined
      },
      set (v) {
        this.reports.splice(this.editReportIndex, 1, v)
      },
    },
  },

  mounted () {
    this.findChartByID({ chartID: this.chartID }).then((chart) => {
      // Make a copy so that we do not change store item by ref
      this.chart = chartConstructor(chart)
      this.onEditReport(0)
    }).catch(this.defaultErrorHandler(this.$t('notification.chart.loadFailed')))
  },

  methods: {
    ...mapActions({
      findChartByID: 'chart/findByID',
      updateChart: 'chart/update',
      deleteChart: 'chart/delete',
    }),

    reporter (r) {
      return this.$ComposeAPI.recordReport({ namespaceID: this.namespace.namespaceID, ...r })
    },

    update () {
      this.processing = true
      this.$refs.chart.updateChart()
    },

    onUpdated () {
      this.processing = false
    },

    handleSave ({ closeOnSuccess = false } = {}) {
      const c = Object.assign({}, this.chart)
      delete (c.config.renderer.data)

      this.updateChart(c).then((chart) => {
        this.chart = chartConstructor(chart)
        this.raiseSuccessAlert(this.$t('notification.chart.saved'))
        if (closeOnSuccess) {
          this.redirect()
        }
      }).catch(this.defaultErrorHandler(this.$t('notification.chart.saveFailed')))
    },

    handleDelete () {
      this.deleteChart(this.chart).then(() => {
        this.raiseSuccessAlert(this.$t('notification.chart.deleted'))
        this.$router.push({ name: 'admin.charts' })
      }).catch(this.defaultErrorHandler(this.$t('notification.chart.deleteFailed')))
    },

    redirect () {
      this.$router.push({ name: 'admin.charts' })
    },

    onEditReport (i) {
      this.editReportIndex = i
    },

    onRemoveReport (i) {
      this.reports.splice(i, 1)
      if (this.editReportIndex === i) {
        this.editReportIndex = undefined
      }
    },

    onAddReport () {
      this.reports.push(this.chart.defReport())
    },
  },
}
</script>
<style lang="scss" scoped>
.chart-preview {
  max-height: 50vh;
}

</style>
